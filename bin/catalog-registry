#!/bin/bash

set -euo pipefail

debug=''
case $1 in
    --debug)
        set -x
        debug=-v
        shift
        ;;
esac

function get_gcr_token() {
    gcloud auth print-access-token
}

# empty 200
# curl -v -L -s -H "Authorization: Bearer $(get_gcr_token)" https://us.gcr.io/v2/_catalog  #  gcr.io/wallaroo-dev-253816/v2/_catalog

# curl -v -L -s -H "Authorization: Bearer $(get_gcr_token)"   https://us.gcr.io/v2/_catalog/gcr.io/wallaroo-dev-253816
# exit

regy=${1:?"Usage: $0 [--debug] registry"}
userpass=""
#proto="--proto-default https"
proto=''

docurl() {
    curl -L -s -k $debug $userpass $proto "$@"
}

case $regy in
    gcr.io*) userpass="--user oauth2accesstoken:$(gcloud auth print-access-token)";;
    *) userpass='';;
    # localhost|127.0.0.1|192.168*) userpass='--user testuser:testpassword' ;;
    # *) echo Teach me how to auth to auth to $regy; exit 1;;
esac

repos=$(docurl $regy/v2/_catalog | jq -r '.repositories|.[]' )

for i in $repos; do
    docurl $regy/v2/$i/tags/list | printf "%-40s %s" "$i" "$(docurl $regy/v2/$i/tags/list | jq -rc '.tags | .[]' | column)"
    echo     
done
